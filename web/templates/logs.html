{% extends "base.html" %}

{% block title %}Logs - Trading Bot Control Panel{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="bi bi-file-text"></i> –õ–æ–≥–∏</h2>
        <small class="text-muted">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ —Ç–æ—Ä–≥–æ–≤–ª–∏</small>
    </div>
</div>

<!-- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="btn-group" role="group">
            <button class="btn btn-primary" onclick="toggleAutoRefresh()">
                <i class="bi bi-arrow-clockwise"></i> <span id="auto-refresh-text">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
            </button>
            <button class="btn btn-success" onclick="refreshLogs()">
                <i class="bi bi-download"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å
            </button>
            <button class="btn btn-info" onclick="downloadLogs()">
                <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å –ª–æ–≥–∏
            </button>
            <button class="btn btn-warning" onclick="clearLogs()">
                <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" id="search-box" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∞–º...">
            <button class="btn btn-outline-secondary" onclick="searchLogs()">
                <i class="bi bi-search"></i> –ü–æ–∏—Å–∫
            </button>
        </div>
    </div>
    <div class="col-md-6">
        <select id="filter-level" class="form-select" onchange="filterLogs()">
            <option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
            <option value="ERROR">‚ùå –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏</option>
            <option value="WARNING">‚ö†Ô∏è –¢–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</option>
            <option value="INFO">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</option>
            <option value="DEBUG">üêõ Debug</option>
            <option value="TRADE">üí∞ –¢–æ–ª—å–∫–æ —Å–¥–µ–ª–∫–∏</option>
        </select>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="stat-box">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-box">
            <div class="stat-value" id="stat-trades">0</div>
            <div class="stat-label">–°–¥–µ–ª–æ–∫</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-box">
            <div class="stat-value" id="stat-errors">0</div>
            <div class="stat-label">–û—à–∏–±–æ–∫</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-box">
            <div class="stat-value" id="stat-size">0 MB</div>
            <div class="stat-label">–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞</div>
        </div>
    </div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∏ -->
<div class="row mb-3">
    <div class="col-md-12">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-view" type="button">
                    <i class="bi bi-list"></i> –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trades-tab" data-bs-toggle="tab" data-bs-target="#trades-view" type="button">
                    <i class="bi bi-coin"></i> –°–¥–µ–ª–∫–∏
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors-view" type="button">
                    <i class="bi bi-exclamation-triangle"></i> –û—à–∏–±–∫–∏
                </button>
            </li>
        </ul>
    </div>
</div>

<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
<div class="tab-content">
    <!-- –õ–æ–≥–∏ -->
    <div class="tab-pane fade show active" id="logs-view" role="tabpanel">
        <div class="card">
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                <div id="logs-container" style="background: rgba(0, 0, 0, 0.4); border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6;">
                    <div class="loading-spinner">
                        <div class="spinner-border" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–¥–µ–ª–∫–∏ -->
    <div class="tab-pane fade" id="trades-view" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div id="trades-container">
                    <div class="loading-spinner">
                        <div class="spinner-border" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—à–∏–±–∫–∏ -->
    <div class="tab-pane fade" id="errors-view" role="tabpanel">
        <div class="card">
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                <div id="errors-container">
                    <div class="loading-spinner">
                        <div class="spinner-border" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .nav-tabs .nav-link {
        color: #bdc3c7;
        border: none;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
    }
    
    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        background: rgba(13, 110, 253, 0.05);
    }
    
    .log-entry {
        padding: 8px 0;
        border-bottom: 1px solid rgba(13, 110, 253, 0.1);
        color: #ecf0f1;
        word-break: break-all;
        transition: background 0.2s ease;
    }
    
    .log-entry:hover {
        background: rgba(13, 110, 253, 0.05);
    }
    
    .log-entry.error {
        color: #ff7b7b;
    }
    
    .log-entry.warning {
        color: #ffc93c;
    }
    
    .log-entry.success {
        color: #74e291;
    }
    
    .log-entry.trade {
        color: #74e291;
        font-weight: 500;
    }
    
    .log-timestamp {
        color: #7f8c8d;
        margin-right: 10px;
    }
    
    .log-level {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        margin-right: 10px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .log-level.error {
        background: rgba(255, 123, 123, 0.2);
        color: #ff7b7b;
    }
    
    .log-level.warning {
        background: rgba(255, 201, 60, 0.2);
        color: #ffc93c;
    }
    
    .log-level.info {
        background: rgba(93, 173, 226, 0.2);
        color: #5dad e2;
    }
    
    .log-level.debug {
        background: rgba(155, 89, 182, 0.2);
        color: #9b59b6;
    }
    
    .trade-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .trade-table th, .trade-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid rgba(13, 110, 253, 0.1);
    }
    
    .trade-table th {
        background: rgba(13, 110, 253, 0.1);
        color: var(--primary-color);
        font-weight: bold;
    }
    
    .trade-table tr:hover {
        background: rgba(13, 110, 253, 0.05);
    }
</style>

<script>
    let allLogs = [];
    let autoRefreshEnabled = false;
    let autoRefreshInterval = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
    async function refreshLogs() {
        try {
            const response = await fetch('/api/logs?lines=500');
            const data = await response.json();
            allLogs = data.logs;
            displayLogs(allLogs);
            updateStats();
        } catch (error) {
            console.error('Error fetching logs:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤', 'danger');
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤
    function displayLogs(logs) {
        let html = '';
        logs.forEach(log => {
            const entry = parseLoglLine(log);
            const classes = `log-entry ${entry.level.toLowerCase()}`;
            
            html += `<div class="${classes}">
                <span class="log-timestamp">${entry.timestamp}</span>
                <span class="log-level ${entry.level.toLowerCase()}">${entry.level}</span>
                <span>${entry.message}</span>
            </div>`;
        });
        
        document.getElementById('logs-container').innerHTML = html || '<div class="text-muted">–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
    }

    // –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞
    function parseLoglLine(log) {
        const timestampMatch = log.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
        const levelMatch = log.match(/- (DEBUG|INFO|WARNING|ERROR) -/);
        
        return {
            timestamp: timestampMatch ? timestampMatch[1] : 'N/A',
            level: levelMatch ? levelMatch[1] : 'INFO',
            message: log
        };
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function updateStats() {
        try {
            const response = await fetch('/api/logs/stats');
            const stats = await response.json();
            
            document.getElementById('stat-total').textContent = formatNumber(stats.total_lines || 0);
            document.getElementById('stat-trades').textContent = formatNumber(stats.trades_count || 0);
            document.getElementById('stat-errors').textContent = formatNumber(stats.errors_count || 0);
            document.getElementById('stat-size').textContent = (stats.file_size_mb || 0) + ' MB';
        } catch (error) {
            console.error('Error fetching stats:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–¥–µ–ª–æ–∫
    async function loadTrades() {
        try {
            const response = await fetch('/api/logs/trades?count=50');
            const data = await response.json();
            
            if (data.trades.length === 0) {
                document.getElementById('trades-container').innerHTML = '<div class="text-muted">–°–¥–µ–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            let html = '<table class="trade-table"><tbody>';
            data.trades.forEach(trade => {
                const entry = parseLoglLine(trade);
                html += `<tr>
                    <td><small class="text-muted">${entry.timestamp}</small></td>
                    <td><small>${entry.message}</small></td>
                </tr>`;
            });
            html += '</tbody></table>';
            
            document.getElementById('trades-container').innerHTML = html;
        } catch (error) {
            console.error('Error loading trades:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫', 'danger');
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—à–∏–±–æ–∫
    async function loadErrors() {
        try {
            const response = await fetch('/api/logs/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keyword: 'ERROR', lines: 100 })
            });
            
            const data = await response.json();
            let html = '';
            
            data.results.forEach(error => {
                const entry = parseLoglLine(error);
                html += `<div class="log-entry error">
                    <span class="log-timestamp">${entry.timestamp}</span>
                    <span class="log-level error">ERROR</span>
                    <span>${entry.message}</span>
                </div>`;
            });
            
            document.getElementById('errors-container').innerHTML = html || '<div class="text-muted">–û—à–∏–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        } catch (error) {
            console.error('Error loading errors:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—à–∏–±–æ–∫', 'danger');
        }
    }

    // –ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∞–º
    async function searchLogs() {
        const keyword = document.getElementById('search-box').value;
        if (!keyword) {
            refreshLogs();
            return;
        }
        
        try {
            const response = await fetch('/api/logs/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keyword: keyword, lines: 500 })
            });
            
            const data = await response.json();
            displayLogs(data.results);
            showNotification(`–ù–∞–π–¥–µ–Ω–æ ${data.count} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤`, 'info');
        } catch (error) {
            console.error('Error searching logs:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞', 'danger');
        }
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ª–æ–≥–æ–≤
    function filterLogs() {
        const level = document.getElementById('filter-level').value;
        if (!level) {
            displayLogs(allLogs);
            return;
        }
        
        const filtered = allLogs.filter(log => log.includes(level));
        displayLogs(filtered);
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤
    async function downloadLogs() {
        try {
            window.location.href = '/api/logs/download';
        } catch (error) {
            console.error('Error downloading logs:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ª–æ–≥–æ–≤', 'danger');
        }
    }

    // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
    async function clearLogs() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –ª–æ–≥–∏.')) return;
        
        try {
            const response = await fetch('/api/logs/clear', { method: 'POST' });
            const result = await response.json();
            
            if (result.success) {
                showNotification('–õ–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã', 'success');
                refreshLogs();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤', 'danger');
            }
        } catch (error) {
            console.error('Error clearing logs:', error);
            showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'danger');
        }
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    function toggleAutoRefresh() {
        autoRefreshEnabled = !autoRefreshEnabled;
        
        if (autoRefreshEnabled) {
            document.getElementById('auto-refresh-text').textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
            autoRefreshInterval = setInterval(() => {
                refreshLogs();
                loadTrades();
            }, 5000);
        } else {
            document.getElementById('auto-refresh-text').textContent = '–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
            clearInterval(autoRefreshInterval);
        }
        
        showNotification(autoRefreshEnabled ? '–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ' : '–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ', 'info');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        refreshLogs();
        loadTrades();
        loadErrors();
        updateStats();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å–¥–µ–ª–æ–∫
        document.getElementById('trades-tab').addEventListener('click', loadTrades);
        document.getElementById('errors-tab').addEventListener('click', loadErrors);
    });
</script>
{% endblock %}
