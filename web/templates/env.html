{% extends "base.html" %}

{% block title %}Environment Variables - Trading Bot Control Panel{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="bi bi-key"></i> Environment Variables</h2>
        <small class="text-muted">Управление переменными окружения (.env файл)</small>
    </div>
</div>

<!-- Предупреждение о безопасности -->
<div class="alert alert-warning" role="alert">
    <i class="bi bi-exclamation-triangle"></i>
    <strong>Важно!</strong> Никогда не коммитьте .env файл в git. 
    Все чувствительные данные (API ключи, пароли) будут замаскированы в этом интерфейсе.
</div>

<!-- Кнопки действия -->
<div class="row mb-3">
    <div class="col-md-12">
        <button class="btn btn-success" onclick="saveEnv()">
            <i class="bi bi-check-circle"></i> Сохранить
        </button>
        <button class="btn btn-warning" onclick="resetEnv()">
            <i class="bi bi-arrow-counterclockwise"></i> Сбросить
        </button>
        <button class="btn btn-info" onclick="addEnvVariable()">
            <i class="bi bi-plus-circle"></i> Добавить переменную
        </button>
    </div>
</div>

<!-- Основные переменные -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-database"></i> Bybit API</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">API KEY</label>
                    <input type="password" id="BYBIT_API_KEY" class="form-control" placeholder="Введите API ключ">
                    <small class="text-muted">Ваш ключ API от Bybit (будет скрыт при сохранении)</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">API SECRET</label>
                    <input type="password" id="BYBIT_API_SECRET" class="form-control" placeholder="Введите API secret">
                    <small class="text-muted">Ваш secret ключ от Bybit</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Тестовый режим</label>
                    <select id="BYBIT_TESTNET" class="form-select">
                        <option value="false">Mainnet (реальная торговля)</option>
                        <option value="true">Testnet (тестирование)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-shield"></i> Веб-интерфейс</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Портобщей администрации</label>
                    <input type="number" id="WEB_PORT" class="form-control" min="1024" max="65535" placeholder="5000">
                    <small class="text-muted">Порт для веб-интерфейса (default: 5000)</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Имя администратора</label>
                    <input type="text" id="ADMIN_USERNAME" class="form-control" placeholder="admin">
                    <small class="text-muted">Имя пользователя для входа</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Пароль администратора</label>
                    <input type="password" id="ADMIN_PASSWORD" class="form-control" placeholder="••••••••">
                    <small class="text-muted">Пароль для входа</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Дополнительные переменные -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-sliders"></i> Дополнительные переменные</h5>
            </div>
            <div class="card-body">
                <div id="env-vars-list">
                    <div class="loading-spinner">
                        <div class="spinner-border" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Пример .env файла -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-file-earmark-code"></i> Пример .env файла</h5>
            </div>
            <div class="card-body">
                <pre style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; color: #95e1d3; overflow-x: auto;"><code># Bybit API credentials
BYBIT_API_KEY=your_api_key_here
BYBIT_API_SECRET=your_api_secret_here
BYBIT_TESTNET=true

# Web Interface
WEB_PORT=5000
ADMIN_USERNAME=admin
ADMIN_PASSWORD=secure_password

# Trading Settings (optional)
MAX_POSITIONS=5
POSITION_SIZE=100
LEVERAGE=10

# Logging
LOG_LEVEL=INFO
LOG_FILE=logs/trading_bot.log
</code></pre>
            </div>
        </div>
    </div>
</div>

<style>
    .env-variable-item {
        background: rgba(13, 110, 253, 0.05);
        border: 1px solid rgba(13, 110, 253, 0.2);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .env-variable-item .var-key {
        color: var(--primary-color);
        font-weight: bold;
        font-family: monospace;
    }
    
    .env-variable-item .var-value {
        flex: 1;
        margin: 0 15px;
    }
    
    .env-variable-item input {
        flex: 1;
    }
</style>

<script>
    let envData = {};

    // Загрузка переменных окружения
    async function loadEnv() {
        try {
            const response = await fetch('/api/env');
            const data = await response.json();
            envData = data;
            
            // Заполнение основных полей
            document.getElementById('BYBIT_API_KEY').value = data.BYBIT_API_KEY || '';
            document.getElementById('BYBIT_API_SECRET').value = data.BYBIT_API_SECRET || '';
            document.getElementById('BYBIT_TESTNET').value = (data.BYBIT_TESTNET === 'true').toString();
            document.getElementById('WEB_PORT').value = data.WEB_PORT || '5000';
            document.getElementById('ADMIN_USERNAME').value = data.ADMIN_USERNAME || 'admin';
            document.getElementById('ADMIN_PASSWORD').value = data.ADMIN_PASSWORD || '';
            
            // Отображение дополнительных переменных
            displayAdditionalVars(data);
        } catch (error) {
            console.error('Error loading env:', error);
            showNotification('Ошибка загрузки переменных окружения', 'danger');
        }
    }

    // Отображение дополнительных переменных
    function displayAdditionalVars(data) {
        const additionalKeys = Object.keys(data).filter(key => 
            !['BYBIT_API_KEY', 'BYBIT_API_SECRET', 'BYBIT_TESTNET', 'WEB_PORT', 'ADMIN_USERNAME', 'ADMIN_PASSWORD'].includes(key)
        );
        
        let html = '';
        if (additionalKeys.length === 0) {
            html = '<p class="text-muted">Дополнительных переменных не найдено</p>';
        } else {
            additionalKeys.forEach(key => {
                html += `
                    <div class="env-variable-item">
                        <span class="var-key">${key}</span>
                        <input type="text" class="form-control env-input" data-key="${key}" value="${data[key] || ''}" style="margin: 0 10px;">
                        <button class="btn btn-sm btn-danger" onclick="deleteEnvVar('${key}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
            });
        }
        
        document.getElementById('env-vars-list').innerHTML = html;
    }

    // Сохранение переменных окружения
    async function saveEnv() {
        try {
            const env = {
                BYBIT_API_KEY: document.getElementById('BYBIT_API_KEY').value,
                BYBIT_API_SECRET: document.getElementById('BYBIT_API_SECRET').value,
                BYBIT_TESTNET: document.getElementById('BYBIT_TESTNET').value,
                WEB_PORT: document.getElementById('WEB_PORT').value,
                ADMIN_USERNAME: document.getElementById('ADMIN_USERNAME').value,
                ADMIN_PASSWORD: document.getElementById('ADMIN_PASSWORD').value,
            };
            
            // Добавление дополнительных переменных
            document.querySelectorAll('.env-input').forEach(input => {
                env[input.dataset.key] = input.value;
            });
            
            const response = await fetch('/api/env', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(env)
            });
            
            const result = await response.json();
            if (result.success) {
                showNotification('.env файл успешно обновлен', 'success');
                loadEnv(); // Перезагрузить для обновления масок
            } else {
                showNotification('Ошибка сохранения', 'danger');
            }
        } catch (error) {
            console.error('Error saving env:', error);
            showNotification('Ошибка: ' + error.message, 'danger');
        }
    }

    // Сброс переменных
    function resetEnv() {
        if (!confirm('Восстановить значения по умолчанию?')) return;
        
        document.getElementById('BYBIT_API_KEY').value = '';
        document.getElementById('BYBIT_API_SECRET').value = '';
        document.getElementById('BYBIT_TESTNET').value = 'true';
        document.getElementById('WEB_PORT').value = '5000';
        document.getElementById('ADMIN_USERNAME').value = 'admin';
        document.getElementById('ADMIN_PASSWORD').value = '';
        
        document.querySelectorAll('.env-input').forEach(input => {
            input.value = '';
        });
        
        showNotification('Поля очищены', 'info');
    }

    // Добавление новой переменной
    function addEnvVariable() {
        const key = prompt('Введите имя переменной (например: MAX_POSITIONS):');
        if (!key) return;
        
        const value = prompt(`Введите значение для ${key}:`);
        if (value === null) return;
        
        const html = `
            <div class="env-variable-item">
                <span class="var-key">${key}</span>
                <input type="text" class="form-control env-input" data-key="${key}" value="${value}" style="margin: 0 10px;">
                <button class="btn btn-sm btn-danger" onclick="deleteEnvVar('${key}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        const container = document.getElementById('env-vars-list');
        if (container.querySelector('p')) {
            container.innerHTML = '';
        }
        
        container.insertAdjacentHTML('beforeend', html);
        showNotification(`Переменная ${key} добавлена`, 'info');
    }

    // Удаление переменной
    function deleteEnvVar(key) {
        if (!confirm(`Удалить переменную ${key}?`)) return;
        
        document.querySelector(`[data-key="${key}"]`).closest('.env-variable-item').remove();
        showNotification(`Переменная ${key} удалена`, 'info');
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', loadEnv);
</script>
{% endblock %}
